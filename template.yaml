# Flatpak Manifest for Google Chrome (Stable)
#
# Author: Senior Linux Systems Engineer
# Architecture: x86_64
# Packaged Version: $VERSION
#
# Description:
# This manifest packages a specific, stable version of Google Chrome.
# To update, you must change the version number in the source URL and
# provide the new corresponding SHA256 checksum.
#

app-id: com.google.Chrome
runtime: org.freedesktop.Platform
runtime-version: '23.08' # Using a recent, stable runtime
sdk: org.freedesktop.Sdk
command: google-chrome-stable # This will be a wrapper script we create

#
# --- Sandboxing & Permissions ---
# These arguments configure the sandbox environment for the application.
# They are chosen to provide core browser functionality while maintaining
# a reasonable level of isolation.
#
finish-args:
  # --- Base Access ---
  - --unshare=ipc # Isolate IPC namespace for Chrome's own processes
  - --share=network # Required for internet access

  # --- Windowing System & Graphics ---
  #- --socket=x11 # X11 windowing system access
  - --socket=wayland # Wayland windowing system access
  - --device=dri # Direct Rendering Infrastructure for hardware acceleration

  # --- Audio & Media ---
  - --socket=pulseaudio # Access to the PulseAudio sound server

  # --- Filesystem Access ---
  # Granting access to XDG user directories is safer than full home access.
  #- --filesystem=xdg-desktop
  #- --filesystem=xdg-documents
  - --filesystem=xdg-download
  #- --filesystem=xdg-music
  #- --filesystem=xdg-pictures
  #- --filesystem=xdg-public-share
  #- --filesystem=xdg-videos
  - --filesystem=xdg-config/gtk-3.0:ro # Read-only access for GTK theming
  - --persist=.config/google-chrome # Persist user profile and configuration
  - --persist=.pki # Persist public key infrastructure (certificates)

  # --- D-Bus Access for Desktop Integration ---
  # Allows the browser to interact with desktop services like notifications,
  # screen saving, and the secret service API for password management.
  - --talk-name=org.freedesktop.Notifications
  - --talk-name=org.freedesktop.secrets
  - --talk-name=org.freedesktop.ScreenSaver
  - --talk-name=org.kde.StatusNotifierWatcher # For system tray icons in KDE

modules:
  - name: google-chrome
    buildsystem: simple
    build-commands:
      # 1. Extract the .deb archive using 'ar', which is part of the standard SDK.
      - ar x google-chrome.deb

      # 2. Extract the data payload, which is usually compressed with xz or zstd.
      # This command robustly handles either compression format.
      - |
        if [ -f data.tar.zst ]; then
          tar -xf data.tar.zst
        elif [ -f data.tar.xz ]; then
          tar -xf data.tar.xz
        else
          echo "Error: data.tar archive not found or has unknown compression."
          exit 1
        fi

      # 3. Move the application files to the standard Flatpak directory /app.
      - cp -r opt/google/chrome /app/
      - cp -r usr/share/applications /app/share/
      - cp -r usr/share/icons /app/share/

      # 4. Create the executable wrapper script.
      - |
        install -Dm755 /dev/stdin /app/bin/google-chrome-stable <<'EOF'
        #!/bin/sh
        exec /app/chrome/google-chrome "$@"
        EOF

      # 5. Modify the .desktop file for Flatpak environment compatibility.
      - sed -i 's|/usr/bin/google-chrome-stable|google-chrome-stable|g' /app/share/applications/google-chrome.desktop
      - sed -i 's|Exec=/opt/google/chrome/google-chrome|Exec=google-chrome-stable|g' /app/share/applications/google-chrome.desktop

      # 6. Integration: Remove conflicting files from the package.
      - sudo touch /etc/default/google-chrome
      - rm -f etc/cron.daily/google-chrome
      - rm -f etc/default/google-chrome

    sources:
      - type: file
        # URL now points to a specific version of Chrome.
        # To update, change the version number in the URL and update the sha256 below.
        # From https://dl.google.com/linux/chrome/deb/dists/stable/main/binary-amd64/Packages
        url: https://dl.google.com/linux/chrome/deb/$FILENAME
        dest-filename: google-chrome.deb
        # IMPORTANT: This SHA256 checksum corresponds to the version in the URL.
        # It must be updated whenever the version is changed.
        # You can get the new checksum by downloading the file and running 'sha256sum <filename>'.
        sha256: '$CHECKSUM' # <-- Placeholder SHA256 for $VERSION
